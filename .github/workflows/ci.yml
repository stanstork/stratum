name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    # Check formatting
    fmt:
        name: Rustfmt
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt

            - name: Check formatting
              run: cargo fmt --all -- --check

    # Lint with Clippy
    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  cache-on-failure: true

            - name: Run Clippy
              run: cargo clippy --all-targets --all-features -- -D warnings

    # Build the project
    build:
        name: Build
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                rust: [stable, beta]
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ matrix.rust }}

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  cache-on-failure: true
                  key: ${{ matrix.os }}-${{ matrix.rust }}

            - name: Build
              run: cargo build --release --all-features

            - name: Build tests
              run: cargo test --no-run --all-features

    # Run integration tests
    test:
        name: Integration Tests
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: postgres
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

            mysql:
                image: mysql:8
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: dummy
                options: >-
                    --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot || exit 1"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
                ports:
                    - 3306:3306

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Install DB clients
              run: |
                  sudo apt-get update
                  sudo apt-get install -y postgresql-client mysql-client

            - name: Wait for Postgres
              run: |
                  for i in {1..30}; do
                    if pg_isready -h localhost -p 5432 -U postgres; then
                      echo "Postgres is up!"
                      break
                    fi
                    echo "Waiting for Postgres..."
                    sleep 2
                  done

            - name: Wait for MySQL
              run: |
                  for i in {1..30}; do
                    if mysqladmin ping -h 127.0.0.1 -P 3306 -uroot -proot --silent; then
                      echo "MySQL is up!"
                      break
                    fi
                    echo "Waiting for MySQL..."
                    sleep 2
                  done

            - name: Setup PostgreSQL (user + db + grants)
              env:
                  PGPASSWORD: postgres
              run: |
                  # Create user "user" and database "testdb" owned by that user
                  psql -h localhost -U postgres -d postgres <<'SQL'
                  DO
                  \$do\$
                  BEGIN
                    IF NOT EXISTS (
                      SELECT FROM pg_catalog.pg_roles WHERE rolname = 'user'
                    ) THEN
                      CREATE ROLE "user" LOGIN PASSWORD 'password';
                    END IF;
                  END
                  \$do\$;

                  DO
                  \$do\$
                  BEGIN
                    IF NOT EXISTS (
                      SELECT FROM pg_database WHERE datname = 'testdb'
                    ) THEN
                      CREATE DATABASE testdb OWNER "user";
                    END IF;
                  END
                  \$do\$;

                  GRANT ALL PRIVILEGES ON DATABASE testdb TO "user";
                  SQL

            - name: Setup MySQL (users + dbs + grants)
              run: |
                  mysql -h 127.0.0.1 -P 3306 -uroot -proot <<'SQL'
                  -- Databases
                  CREATE DATABASE IF NOT EXISTS sakila;
                  CREATE DATABASE IF NOT EXISTS testdb;

                  -- Users
                  CREATE USER IF NOT EXISTS 'sakila_user'@'%' IDENTIFIED BY 'qwerty123';
                  CREATE USER IF NOT EXISTS 'user'@'%' IDENTIFIED BY 'password';

                  -- Grants
                  GRANT ALL PRIVILEGES ON sakila.* TO 'sakila_user'@'%';
                  GRANT ALL PRIVILEGES ON testdb.* TO 'user'@'%';
                  FLUSH PRIVILEGES;
                  SQL

                  # Seed Sakila schema
                  mysql -h 127.0.0.1 -P 3306 -usakila_user -pqwerty123 sakila \
                      < .github/workflows/sakila-schema.sql

                  # Seed Sakila data
                  mysql -h 127.0.0.1 -P 3306 -usakila_user -pqwerty123 sakila \
                      < .github/workflows/sakila-data.sql

                  # Seed Orders DB
                  mysql -h 127.0.0.1 -P 3306 -uuser -ppassword testdb \
                      < .github/workflows/testdb.sql

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  cache-on-failure: true

            - name: Run integration tests
              run: cargo test -- --test-threads=1

    # Check documentation
    docs:
        name: Documentation
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  cache-on-failure: true

            - name: Check documentation
              run: cargo doc --no-deps --all-features
              env:
                  RUSTDOCFLAGS: -D warnings

    # Security audit
    audit:
        name: Security Audit
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Run cargo-audit
              uses: rustsec/audit-check@v2
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

    # Check that everything passed
    ci-success:
        name: CI Success
        needs: [fmt, clippy, build, test, docs, audit]
        runs-on: ubuntu-latest
        if: always()
        steps:
            - name: Check all jobs succeeded
              if: ${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}
              run: exit 1
